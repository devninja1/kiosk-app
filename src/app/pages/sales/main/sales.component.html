<div class="sales-container">
  <div class="sales-header">
    <h1>Sales</h1>
  </div>

  <div class="sales-toolbar">
    <mat-form-field appearance="outline" class="customer-field">
      <mat-label>Search for a Customer</mat-label>
      <input
        type="text"
        matInput
        [formControl]="customerSearch"
        [matAutocomplete]="autoCustomer">
      <button mat-icon-button matSuffix aria-label="Clear customer" *ngIf="customerSearch.value" (click)="clearSelectedCustomer()">
        <mat-icon>close</mat-icon>
      </button>
      <mat-autocomplete #autoCustomer="matAutocomplete" [displayWith]="displayCustomer" (optionSelected)="onCustomerSelected($event)">
        @for (customer of filteredCustomers$ | async; track customer.id) {
          <mat-option [value]="customer">
            #{{customer.customerId}} - {{customer.name}}
          </mat-option>
        }
        @if (((filteredCustomers$ | async)?.length === 0) && customerSearch.value && (typeof customerSearch.value === 'string')) {
          <mat-option (click)="createNewCustomer(customerSearch.value)">
            <mat-icon>add</mat-icon>
            Create new customer: "{{customerSearch.value}}"
          </mat-option>
        }
      </mat-autocomplete>
    </mat-form-field>

    <mat-form-field appearance="outline" class="order-date-field">
      <mat-label>Order Date</mat-label>
      <input matInput [matDatepicker]="orderDatePicker" [formControl]="orderDate">
      <mat-datepicker-toggle matIconSuffix [for]="orderDatePicker"></mat-datepicker-toggle>
      <mat-datepicker #orderDatePicker></mat-datepicker>
    </mat-form-field>
  </div>

  @if (lastSavedSale) {
    <mat-card class="sale-summary-card mat-elevation-z2">
      <div class="sale-summary-header">
        <div class="sale-summary-title">Sale Summary</div>
        <button mat-icon-button type="button" aria-label="Close sale summary" (click)="dismissSaleSummary()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <mat-card-content>
        <div>Sale ID: {{ lastSavedSaleId }}</div>
        <div>
          Customer:
          {{ lastSavedSale.customer_name }}
          @if (lastSavedSale.customer_id !== null && lastSavedSale.customer_id !== undefined) {
            <span class="customer-id">(ID: {{ lastSavedSale.customer_id }})</span>
          }
        </div>
        <div>Items: {{ lastSavedSale.order_items.length }}</div>
        <div>Discount: {{ lastSavedSale.discount | currency:currencyCode:'symbol' }}</div>
        <div>Total: {{ lastSavedSale.total_amount | currency:currencyCode:'symbol' }}</div>
      </mat-card-content>
      <mat-card-actions align="end">
        <button mat-raised-button color="primary" (click)="printLastSavedSale()">
          <mat-icon>print</mat-icon>
          Print Receipt
        </button>
        <button mat-stroked-button (click)="editLastSavedSale()">
          <mat-icon>edit</mat-icon>
          Edit Order
        </button>
      </mat-card-actions>
    </mat-card>
  }
  <app-sales-entry
    [products]="(products$ | async) ?? []"
    [addedProductNames]="addedProductNames"
    (itemAdded)="onItemAdded($event)">
  </app-sales-entry>

  <app-sales-list
    [salesList]="salesList"
    (itemDeleted)="onItemDeleted($event)"
    (quantityChanged)="onQuantityChanged($event)">
  </app-sales-list>

  @if (salesList.length > 0) {
    <div class="save-sale-container">
      <button mat-raised-button color="primary" class="save-button" (click)="saveSale()">
        <mat-icon>save</mat-icon>
        @if (isEditing) {
          Update Sale
        } @else {
          Save Sale
        }
      </button>
    </div>
  }
</div>